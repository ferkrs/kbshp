<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Barberos - Kings Barber Shop</title>
    <!-- Meta viewport para responsividad en dispositivos móviles -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SweetAlert CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Montserrat', sans-serif;
        }
        .navbar-brand {
            font-weight: 600;
            font-size: 1.5rem;
        }
        .card {
            margin-bottom: 1.5rem;
        }
        .card-header {
            font-weight: 600;
        }
        .btn {
            font-weight: 600;
        }
        .status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
        }
        /* Responsive adjustments */
        @media (max-width: 576px) {
            .navbar-brand {
                font-size: 1.25rem;
            }
            .card-title {
                font-size: 1.1rem;
            }
            .status-badge {
                top: 10px;
                right: 10px;
            }
            .btn {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }
            .card-body {
                padding: 1rem;
            }
            h4 {
                font-size: 1.25rem;
            }
            h5 {
                font-size: 1.1rem;
            }
            /* Aumentar el tamaño de los botones principales */
            #closeDayBtn {
                width: 100%;
            }
        }

        /* Mejorar la legibilidad en dispositivos móviles */
        @media (max-width: 768px) {
            .card-body p, .card-body ul, .card-body table {
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>
<div class="container my-4">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark rounded mb-4">
        <div class="container-fluid">
            <a class="navbar-brand mx-auto" href="#">Kings Barber Shop</a>
        </div>
    </nav>

    <!-- Sección para agregar barberos y generar tickets -->
    <div class="row mb-4">
        <!-- Agregar Barbero -->
        <div class="col-12 col-md-6 mb-3 mb-md-0">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Agregar Barbero</h5>
                </div>
                <div class="card-body">
                    <form id="barberForm">
                        <div class="input-group">
                            <input type="text" id="barberName" class="form-control" placeholder="Nombre del barbero" required>
                            <button type="submit" class="btn btn-primary">Agregar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Generar Ticket -->
        <div class="col-12 col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Generar Ticket de Cliente</h5>
                </div>
                <div class="card-body">
                    <form id="ticketForm">
                        <div class="mb-3">
                            <input type="text" id="customerName" class="form-control" placeholder="Nombre del cliente" required>
                        </div>
                        <div class="mb-3">
                            <select id="barberSelect" class="form-select">
                                <option value="esperar">Esperar Turno</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Generar Ticket</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de barberos y clientes -->
    <div class="mb-4">
        <h4 class="mb-3">Barberos y Clientes</h4>
        <div id="barberClientsCards" class="row"></div>
    </div>

    <!-- Sección de clientes en cola -->
    <div class="mb-4">
        <h4 class="mb-3">Clientes en Cola</h4>
        <ul id="customerQueue" class="list-group"></ul>
    </div>

    <!-- Registro de clientes atendidos -->
    <div class="mb-4">
        <h4 class="mb-3">Registro de Clientes Atendidos</h4>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Cliente</th>
                    <th>Barbero</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                </tr>
                </thead>
                <tbody id="attendanceLog"></tbody>
            </table>
        </div>
    </div>

    <!-- Botón para cerrar el día -->
    <div class="text-center mb-4">
        <button id="closeDayBtn" class="btn btn-danger btn-lg">Cerrar Día</button>
    </div>

    <!-- Modal para editar barbero -->
    <div class="modal fade" id="editBarberModal" tabindex="-1" aria-labelledby="editBarberModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="editBarberModalLabel">Editar Barbero</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="editBarberName" class="form-control mb-3" placeholder="Nombre del barbero" required>
                    <input type="hidden" id="editBarberId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveBarberChanges">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    let barbers = JSON.parse(localStorage.getItem('barbers')) || [];
    let customerQueue = JSON.parse(localStorage.getItem('customerQueue')) || [];
    let attendanceLog = JSON.parse(localStorage.getItem('attendanceLog')) || [];

    const barberForm = document.getElementById('barberForm');
    const ticketForm = document.getElementById('ticketForm');
    const barberSelect = document.getElementById('barberSelect');
    const barberClientsCards = document.getElementById('barberClientsCards');
    const customerQueueList = document.getElementById('customerQueue');
    const attendanceLogTable = document.getElementById('attendanceLog');
    const closeDayBtn = document.getElementById('closeDayBtn');

    // Función para mostrar los barberos y sus clientes
    const displayBarberCards = () => {
        barberClientsCards.innerHTML = '';
        barberSelect.innerHTML = '<option value="esperar">Esperar Turno</option>';
        barbers.forEach((barber, index) => {
            const card = document.createElement('div');
            card.classList.add('col-12', 'col-md-6', 'col-lg-4'); // Ajuste de columnas para diferentes tamaños

            let clientsHtml = '';
            if (barber.clients && barber.clients.length > 0) {
                clientsHtml += '<ul class="list-group">';
                barber.clients.forEach((client, clientIndex) => {
                    clientsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${client.name}
                            <button class="btn btn-success btn-sm" onclick="completeCustomer(${index}, ${clientIndex})">
                                Terminar
                            </button>
                        </li>
                    `;
                });
                clientsHtml += '</ul>';
            } else {
                clientsHtml = '<p>No tiene clientes asignados.</p>';
            }

            // Indicador de estado
            const statusBadge = barber.isActive
                ? '<span class="badge bg-success status-badge">Activo</span>'
                : '<span class="badge bg-secondary status-badge">Inactivo</span>';

            card.innerHTML = `
                <div class="card card-barber mb-4 shadow-sm position-relative">
                    ${statusBadge}
                    <div class="card-body">
                        <h5 class="card-title">${barber.name}</h5>
                        <p><strong>Clientes Atendidos:</strong> ${barber.totalClientesAtendidos || 0}</p>
                        ${clientsHtml}
                        <div class="mt-3 d-flex flex-wrap gap-2">
                            <button class="btn btn-warning btn-sm flex-grow-1" onclick="openEditBarberModal(${index})">Editar</button>
                            <button class="btn btn-danger btn-sm flex-grow-1" onclick="deleteBarber(${index})">Eliminar</button>
                            <button class="btn btn-${barber.isActive ? 'secondary' : 'success'} btn-sm flex-grow-1" onclick="toggleBarberStatus(${index})">
                                ${barber.isActive ? 'Desactivar' : 'Activar'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            barberClientsCards.appendChild(card);

            // Solo agregar barberos activos al select
            if (barber.isActive) {
                barberSelect.innerHTML += `<option value="${index}">${barber.name}</option>`;
            }
        });
    };

    // Función para mostrar la cola de clientes
    const displayCustomerQueue = () => {
        customerQueueList.innerHTML = '';
        if (customerQueue.length === 0) {
            customerQueueList.innerHTML = '<li class="list-group-item">No hay clientes en cola.</li>';
        } else {
            customerQueue.forEach((customer, index) => {
                const li = document.createElement('li');
                li.classList.add('list-group-item');
                li.textContent = `${index + 1}. ${customer.name}`;
                customerQueueList.appendChild(li);
            });
        }
    };

    // Función para mostrar el registro de asistencia
    const displayAttendanceLog = () => {
        attendanceLogTable.innerHTML = '';
        if (attendanceLog.length === 0) {
            attendanceLogTable.innerHTML = '<tr><td colspan="4" class="text-center">No hay registros.</td></tr>';
        } else {
            attendanceLog.forEach(log => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${log.cliente}</td>
                    <td>${log.barbero}</td>
                    <td>${log.fecha}</td>
                    <td>${log.hora}</td>
                `;
                attendanceLogTable.appendChild(row);
            });
        }
    };

    // Función para agregar un barbero
    barberForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const barberName = document.getElementById('barberName').value.trim();
        if (barberName) {
            const newBarber = {
                name: barberName,
                clients: [],
                totalClientesAtendidos: 0,
                isActive: true // Barbero activo por defecto
            };
            barbers.push(newBarber);
            localStorage.setItem('barbers', JSON.stringify(barbers));
            displayBarberCards();
            barberForm.reset();
            Swal.fire({
                icon: 'success',
                title: 'Barbero Agregado',
                text: `Barbero ${barberName} agregado exitosamente.`,
                showConfirmButton: false,
                timer: 2000
            });
        }
    });

    // Función para generar un ticket de cliente
    ticketForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const customerName = document.getElementById('customerName').value.trim();
        const selectedBarber = barberSelect.value;

        if (customerName) {
            const customer = { name: customerName };
            if (selectedBarber === 'esperar') {
                customerQueue.push(customer);
                localStorage.setItem('customerQueue', JSON.stringify(customerQueue));
                displayCustomerQueue();
                Swal.fire({
                    icon: 'info',
                    title: 'Cliente en Cola',
                    text: `Cliente ${customerName} agregado a la cola.`,
                    showConfirmButton: false,
                    timer: 2000
                });
                assignCustomersToFreeBarbers();
            } else {
                assignCustomerToBarber(customer, parseInt(selectedBarber));
            }
            ticketForm.reset();
        }
    });

    // Función para asignar clientes en cola a barberos libres
    const assignCustomersToFreeBarbers = () => {
        barbers.forEach((barber, index) => {
            if (barber.isActive && barber.clients.length === 0 && customerQueue.length > 0) {
                const nextCustomer = customerQueue.shift();
                localStorage.setItem('customerQueue', JSON.stringify(customerQueue)); // Actualizar localStorage
                assignCustomerToBarber(nextCustomer, index);
            }
        });
        displayCustomerQueue();
    };

    // Función para asignar un cliente a un barbero
    const assignCustomerToBarber = (customer, barberIndex) => {
        if (barbers[barberIndex].isActive) {
            barbers[barberIndex].clients.push(customer);
            localStorage.setItem('barbers', JSON.stringify(barbers));
            displayBarberCards();
            displayCustomerQueue();
            Swal.fire({
                icon: 'success',
                title: 'Cliente Asignado',
                text: `Cliente ${customer.name} asignado a ${barbers[barberIndex].name}.`,
                showConfirmButton: false,
                timer: 2000
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Barbero Inactivo',
                text: `El barbero seleccionado está inactivo.`,
                showConfirmButton: false,
                timer: 2000
            });
        }
    };

    // Función para completar la atención de un cliente
    window.completeCustomer = (barberIndex, clientIndex) => {
        const barber = barbers[barberIndex];
        const finishedCustomer = barber.clients.splice(clientIndex, 1)[0];
        const date = new Date();
        const logEntry = {
            cliente: finishedCustomer.name,
            barbero: barber.name,
            fecha: date.toLocaleDateString(),
            hora: date.toLocaleTimeString()
        };
        attendanceLog.push(logEntry);
        barber.totalClientesAtendidos += 1;
        localStorage.setItem('barbers', JSON.stringify(barbers));
        localStorage.setItem('attendanceLog', JSON.stringify(attendanceLog));
        Swal.fire({
            icon: 'success',
            title: 'Atención Completada',
            text: `Cliente ${finishedCustomer.name} atendido por ${barber.name}.`,
            showConfirmButton: false,
            timer: 2000
        });
        displayAttendanceLog();
        displayBarberCards();
        assignCustomersToFreeBarbers();
    };

    // Función para abrir el modal de edición de barbero
    window.openEditBarberModal = (index) => {
        const barber = barbers[index];
        document.getElementById('editBarberName').value = barber.name;
        document.getElementById('editBarberId').value = index;
        const editModal = new bootstrap.Modal(document.getElementById('editBarberModal'));
        editModal.show();
    };

    // Función para guardar los cambios del barbero
    document.getElementById('saveBarberChanges').addEventListener('click', () => {
        const index = document.getElementById('editBarberId').value;
        const barberName = document.getElementById('editBarberName').value.trim();
        if (barberName) {
            barbers[index].name = barberName;
            localStorage.setItem('barbers', JSON.stringify(barbers));
            displayBarberCards();
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editBarberModal'));
            editModal.hide();
            Swal.fire({
                icon: 'success',
                title: 'Barbero Actualizado',
                text: `Barbero actualizado a ${barberName}.`,
                showConfirmButton: false,
                timer: 2000
            });
        }
    });

    // Función para eliminar un barbero
    window.deleteBarber = (index) => {
        Swal.fire({
            title: 'Eliminar Barbero',
            text: `¿Deseas eliminar al barbero ${barbers[index].name}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                barbers.splice(index, 1);
                localStorage.setItem('barbers', JSON.stringify(barbers));
                displayBarberCards();
                Swal.fire({
                    icon: 'success',
                    title: 'Barbero Eliminado',
                    text: `Barbero eliminado exitosamente.`,
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        });
    };

    // Función para activar/desactivar un barbero
    window.toggleBarberStatus = (index) => {
        barbers[index].isActive = !barbers[index].isActive;
        localStorage.setItem('barbers', JSON.stringify(barbers));
        displayBarberCards();
        Swal.fire({
            icon: 'info',
            title: 'Estado Actualizado',
            text: `El barbero ahora está ${barbers[index].isActive ? 'activo' : 'inactivo'}.`,
            showConfirmButton: false,
            timer: 2000
        });
        assignCustomersToFreeBarbers();
    };

    // Función para cerrar el día
    closeDayBtn.addEventListener('click', () => {
        Swal.fire({
            title: 'Cerrar Día',
            text: '¿Estás seguro de cerrar el día? Se reiniciarán los contadores.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, cerrar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                barbers.forEach(barber => {
                    barber.totalClientesAtendidos = 0;
                    barber.clients = [];
                });
                customerQueue = [];
                attendanceLog = [];
                localStorage.setItem('barbers', JSON.stringify(barbers));
                localStorage.setItem('customerQueue', JSON.stringify(customerQueue));
                localStorage.setItem('attendanceLog', JSON.stringify(attendanceLog));
                displayBarberCards();
                displayCustomerQueue();
                displayAttendanceLog();
                Swal.fire({
                    icon: 'success',
                    title: 'Día Cerrado',
                    text: 'El día ha sido cerrado exitosamente.',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        });
    });

    // Inicializar la interfaz
    displayBarberCards();
    displayCustomerQueue();
    displayAttendanceLog();
});
</script>
</body>
</html>
